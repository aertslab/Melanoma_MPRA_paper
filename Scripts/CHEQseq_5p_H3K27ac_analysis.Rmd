---
title: "R Notebook - 5' Plasmid construct Count"
output: html_notebook
---


```{r}
setwd(dir = "/staging/leuven/stg_00002/lcb/lcb_projects/CH1/5p_intron/analysis/")
library(dplyr)
library(ggplot2)
source("/staging/leuven/stg_00002/lcb/lcb_projects/CH1/5p_intron/analysis/utils.R")
```

# Create environment
```{r}
CH1.5p <- new.env()
```

# Analysis by MM line
## Process
```{r}
## MM001
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM001",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__17c539__CheqSeq_MM001_5_plasmid_DNA_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CH1__773627__CheqSeqMM001_5_cDNA_count_final_clean_NEG.txt")
## MM029
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM029",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM029_5_Plasmid_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM029_5_cDNA_count_final_clean_NEG.txt")
## MM047
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM047",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM047_5_Plasmid_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM047_5_cDNA_count_final_clean_NEG.txt")
## MM057
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM057",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM057_5_Plasmid_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM057_5_cDNA_count_final_clean_NEG.txt")
## MM074
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM074",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM074_5_Plasmid_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM074_5_cDNA_count_final_clean_NEG.txt")
## MM087 rep1
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM087_rep1",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM087_5_Plasmid_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM087_5_cDNA_count_final_clean_NEG.txt")
## MM087 rep2
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM087_rep2",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM087_5_Plasmid_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CSE__243721__CheqSeq_cDNA_MM087_5_prime_sample_1_final_clean_NEG.txt")
## MM087 rep3
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM087_rep3",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__CheqSeq_MM087_5_Plasmid_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CSE__493839__CheqSeq_cDNA_MM087_5_prime_sample_2_final_clean_NEG.txt")


## MM099
CH1.5p <- ProcessCHEQseq(env = CH1.5p, 
                         line = "MM099",
                         library = "long",
                         filter.method = "min.barcodes",
                         min.barcodes = 5,
                         plasmid.counts.file.path = "../counting/10.bc_count/CH1__3ce78b__CheqSeq_MM099_5_plasmid_DNA_count_final_clean_NEG.txt",
                         cDNA.counts.file.path = "../counting/10.bc_count/CH1__37547d__CheqSeq_MM099_5_cDNA_count_final_clean_NEG.txt")
# Save env
saveRDS(object = CH1.5p, file = "data/CHEQseq__5p__R_environment.RDS")
```

# Load environment
```{r}
CH1.5p <- readRDS(file = "data/CHEQseq__5p__R_environment.RDS")
```

# Combine replicates
```{r}
# Calculate mean of replicates
library(dplyr)
CH1.5p.87.df <- inner_join(CH1.5p$MM087_rep1$merged.cpm.input.norm[,c("enhancer", "phenotype", "CPMNorm.FC")], CH1.5p$MM087_rep2$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC")], by = "enhancer") %>% inner_join(CH1.5p$MM087_rep3$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC")], by = "enhancer")
CH1.5p.87.df$mean.CPMNorm.FC <- rowMeans(CH1.5p.87.df[,c("CPMNorm.FC.x", "CPMNorm.FC.y", "CPMNorm.FC")])
CH1.5p$MM087$merged.cpm.input.norm <- CH1.5p.87.df[,c("enhancer", "mean.CPMNorm.FC", "phenotype")]
names(CH1.5p$MM087$merged.cpm.input.norm) <- c("enhancer", "CPMNorm.FC", "phenotype")
```

# Barcode violin
```{r}
library(reshape2)
MM.5p.bc<-rbind(data.frame("MM.line"=rep("MM001",nrow(CH1.5p[["MM001"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM001"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM001"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM057",nrow(CH1.5p[["MM057"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM057"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM057"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM074",nrow(CH1.5p[["MM074"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM074"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM074"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM087_rep1",nrow(CH1.5p[["MM087_rep1"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM087_rep1"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM087_rep1"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM087_rep2",nrow(CH1.5p[["MM087_rep2"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM087_rep2"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM087_rep2"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM087_rep3",nrow(CH1.5p[["MM087_rep3"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM087_rep3"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM087_rep3"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM029",nrow(CH1.5p[["MM029"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM029"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM029"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM047",nrow(CH1.5p[["MM047"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM047"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM047"]]$cDNA.raw$num.barcodes),
                data.frame("MM.line"=rep("MM099",nrow(CH1.5p[["MM099"]]$plasmid.raw)), 
                           "Plasmid"=CH1.5p[["MM099"]]$plasmid.raw$num.barcodes, 
                           "cDNA"=CH1.5p[["MM099"]]$cDNA.raw$num.barcodes))
MM.5p.bc<-melt(MM.5p.bc, id="MM.line")
library(ggplot2)
ggplot(MM.5p.bc, aes(x=MM.line, y=value, fill = variable)) + 
    geom_violin() +
    geom_boxplot(width = 0.3, position=position_dodge(0.9)) +
    geom_hline(yintercept = 5, linetype="dashed", color = "black", size = 0.5) +
    theme(panel.background = element_blank(),
          panel.grid = element_blank(),
          legend.title = element_blank(),
          legend.key = element_rect(fill = "white"),
          axis.text = element_text(color = "black"),
          axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.x=element_blank()) +
    annotation_logticks(sides = "l") +
    scale_y_continuous(trans='log10') +
    scale_fill_manual(values = c("#70DB70", "#BA6ACB"), labels = c("Plasmid", "cDNA")) +
    labs(y = "Barcode per enhancer")
ggsave(filename = "Plots/CHEQseq_5p_BC_range.pdf",device = "pdf", width = 6, height = 3)
```

## PLot enhancer activity per cell line
```{r}
library(RColorBrewer)
library(ggplot2)
for (i in c("MM001", "MM029", "MM047", "MM057", "MM074", "MM087", "MM099")) {
p<-ggplot(CH1.5p[[i]]$merged.cpm.input.norm[CH1.5p[[i]]$merged.cpm.input.norm$enhancer != "NEG_CTRL",], aes(x = reorder(x = enhancer, X = log2(CPMNorm.FC), FUN=median), y = log2(CPMNorm.FC), fill = phenotype)) +
  geom_point(pch = 21, size = 2.5) +
  geom_hline(yintercept = log2(CH1.5p[[i]]$merged.cpm.input.norm[CH1.5p[[i]]$merged.cpm.input.norm$enhancer == "NEG_CTRL","CPMNorm.FC"]), linetype="dashed", color = "black", size = 0.5) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text = element_text(color = "black", size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title = element_text(size = 8),
        legend.key = element_blank(),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        legend.key.size = unit(0.8,"line")) +
  scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  labs(x = "Enhancers", y = "Log2 FC", fill = "Enhancer\nphenotype", title = paste0(i," - CHEQseq 5'"))
  ggsave(filename = paste0("Plots/Activity_per_line/5p/CHEQseq_5p_Enhancers_activity_",i,".pdf"),device = "pdf",width = 7,height = 3.5)
print(p)
}
```

### Plotting all lines (expression) and  highlighting inactive enhancers
```{r}
library(ggplot2)
for (i in c("MM001", "MM029", "MM047", "MM057", "MM074", "MM087", "MM099")) {
  tmp <- CH1.5p[[i]]$merged.cpm.input.norm[CH1.5p[[i]]$merged.cpm.input.norm$enhancer != "NEG_CTRL",]
  tmp$color <- ifelse(tmp$enhancer %in% c("MAP3K14_-2-D","BLK_21-I","BLK_22-I","ALPK2_49-E","BDNF_P", "SMURF2_-47-D","MITF_P", "GPM6B_P", "SOX10_15-3U"), "1", "0")
p <- ggplot(tmp, aes(x = reorder(x = enhancer, X = log2(CPMNorm.FC), FUN=median), y = log2(CPMNorm.FC), fill = color)) +
  geom_point(pch = 21, size = 2.5) +
  geom_hline(yintercept = log2(1), linetype="dashed", color = "black", size = 0.5) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        axis.text = element_text(color = "black", size = 7),
        axis.text.x = element_text(angle = 60, hjust = 1),
        axis.title = element_text(size = 8),
        legend.key = element_blank(),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        legend.key.size = unit(0.8,"line")) +
  scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("Inactive", "Active")) +
  ggtitle(label = paste0(i)) +
  labs(x = "Enhancers", y = "Log2 Expression", fill = "Inactive\nenhancers")
# ggsave(filename = paste0("Plots/Activity_per_line/Intron/CHEQseq_Intron_Enhancers_expression_",i,".pdf"),device = "pdf",width = 7,height = 3)
print(p)
}
```

## Define activity via fit of Gaussian curve
```{r}
library(ggplot2)
library(robustbase)
library(stats)
j <- c("MAP3K14_-2-D","BLK_21-I","BLK_22-I","ALPK2_49-E","BDNF_P", "SMURF2_-47-D","MITF_P", "GPM6B_P", "SOX10_15-3U")

for (i in names(CH1.5p)[-which(names(CH1.5p) %in% c("MM087_rep1", "MM087_rep2", "MM087_rep3"))]) {
  print(i)
  sample <- CH1.5p[[i]]$merged.cpm.input.norm[CH1.5p[[i]]$merged.cpm.input.norm$enhancer != "NEG_CTRL",]
  
   # Test normality of control values with Shapiro-Wilk test
  norm.test <-shapiro.test(sample[sample$enhancer %in% j,"CPMNorm.FC"])
  print(paste0("Normality test: ",norm.test$p.value))
  
  # Robust fit of a gaussian by robust estimates of it's two params from the enhancer values of the opposite phenotype (MEL enh for MES lines and MES enh for MEL lines)
  if (norm.test$p.value < 0.05){
    # If the values of control regions are not normally distributed: Use log2 FC values to fit the Gaussian
    print("Control regions values are NOT normally distributed")
    location <- median(x = log2(sample[sample$enhancer %in% j, "CPMNorm.FC"]))
    print(paste0("Median: ",location))
    scale <- mad(x = log2(sample[sample$enhancer %in% j, "CPMNorm.FC"]))
    
    # Check fit
    p2 <- ggplot(data = sample, mapping = aes(x = log2(CPMNorm.FC), fill = phenotype)) +
            geom_density(size = 0, alpha = .5) +  
            stat_function(fun = dnorm, args = list(mean = location, sd = scale)) +
            ggtitle(label = paste0(i)) +
            theme_minimal()
    print(p2)
    
    # Determine p-values for all
    sample$pvalue <- pnorm(q = log2(sample$CPMNorm.FC), mean = location, sd = scale, lower.tail = F)
    sample$padj <- p.adjust(p = sample$pvalue, method = "fdr") 
  } else {
    # If the values of control regions are normally distributed: Use FC values to fit the Gaussian
    print("Control regions values are normally distributed")
    location <- median(x = sample[sample$enhancer %in% j, "CPMNorm.FC"])
    print(paste0("Median: ",location))
    scale <- mad(x = sample[sample$enhancer %in% j, "CPMNorm.FC"])
    
    # Check fit
    p2 <- ggplot(data = sample, mapping = aes(x = CPMNorm.FC, fill = phenotype)) +
            geom_density(size = 0, alpha = .5) +  
            stat_function(fun = dnorm, args = list(mean = location, sd = scale)) +
            ggtitle(label = paste0(i)) +
            theme_minimal()
    print(p2)
    
    # Determine p-values for all
    sample$pvalue <- pnorm(q = sample$CPMNorm.FC, mean = location, sd = scale, lower.tail = F)
    sample$padj <- p.adjust(p = sample$pvalue, method = "fdr")
  }
  
  # Controlling the FDR on this should result in < 5% false discoveries
  print(table(sample[sample$padj < 0.05, "phenotype"])/sum(sample$padj < 0.05)*100)
  print(nrow(sample[sample$padj < 0.05,]))
  
  # Save results
  CH1.5p[[i]]$merged.cpm.input.norm <- sample
  
  p3 <- ggplot(data = sample, mapping = aes(x = padj < 0.05, fill = phenotype)) + 
          geom_bar() + 
          ggtitle(label = paste0(i)) +
          theme_minimal()
  print(p3)

  p <- ggplot(sample, aes(x = reorder(x = enhancer, X = log2(CPMNorm.FC), FUN=median), y = log2(CPMNorm.FC), fill = phenotype)) +
        geom_point(pch = 21, size = 3, aes(color = ifelse(padj < 0.05, "<0.05",">=0.05"))) +
        theme(panel.background = element_blank(),
              panel.grid = element_blank(),
              axis.text = element_text(color = "black", size = 7.2),
              axis.text.y = element_text(size = 8.5),
              axis.text.x = element_text(angle = 60, hjust = 1),
              axis.title = element_text(size = 9),
              legend.key = element_blank(),
              legend.title = element_text(size = 7),
              legend.text = element_text(size = 7),
              legend.key.size = unit(0.8,"line")) +
        scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
        scale_color_manual(values = c('black', 'grey80')) +
        ggtitle(label = paste0(i)) +
        labs(x = "Enhancers", y = "Log2 FC", color = "Adjusted\np-value", fill = "Enhancer\nPhenotype")
  ggsave(filename = paste0("Plots/Activity_per_line/5p/CHEQseq_5p_Enhancers_expression_",i,".pdf"), device = "pdf",width = 7,height = 3, useDingbats = F)
  print(p)
  
  ## Make shape categories
  sample$pch <- "Others"
  sample[sample$enhancer %in% c("TYR_-9-D", "TYR_-1-D", "TYR_P"),"pch"] <- "TYR"
  #sample[sample$enhancer %in% c("SOX10_1","SOX10_2","SOX10_3","SOX10_4","SOX10_5"),"pch"] <- "SOX10"
  
  p <- ggplot(sample[sample$enhancer != "NEG_CTRL",], aes(x = reorder(x = enhancer, X = log2(CPMNorm.FC), FUN=median), y = log2(CPMNorm.FC), fill = phenotype)) +
        geom_point(size = 3, aes(shape = sample[sample$enhancer != "NEG_CTRL","pch"], color = ifelse(padj < 0.05, "<0.05",">=0.05"))) +
        theme(panel.background = element_blank(),
              panel.grid = element_blank(),
              axis.text = element_text(color = "black", size = 7.2),
              axis.text.y = element_text(size = 8.5),
              axis.text.x = element_text(angle = 60, hjust = 1),
              axis.title = element_text(size = 9),
              legend.key = element_blank(),
              legend.title = element_text(size = 7),
              legend.text = element_text(size = 7),
              legend.key.size = unit(0.8,"line")) +
        scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
        scale_shape_manual(values = c(21,22,23,24)) +
        scale_color_manual(values = c('black', 'grey80')) +
        ggtitle(label = paste0(i)) +
        labs(x = "Enhancers", y = "Log2 FC", color = "Adjusted\np-value", fill = "Enhancer\nPhenotype", shape = NULL)
  ggsave(filename = paste0("Plots/Activity_per_line/5p/CHEQseq_5p_Enhancers_expression_",i,"_with_shapes.pdf"), device = "pdf",width = 7,height = 3, useDingbats = F)
  print(p)
  
      ## Make shape categories MES
  sample$pch <- "Others"
  sample[sample$enhancer %in% c("COL5A1_-139-D", "COL5A1_-89-D", "COL5A1_-50-D", "COL5A1_-39-D", "COL5A1_-17-D", "COL5A1_-4-D", "COL5A1_21-I"),"pch"] <- "COL5A1"
  sample[sample$enhancer %in% c("SERPINE1_-110-I", "SERPINE1_-27-D", "SERPINE1_-5-D"),"pch"] <- "SERPINE1"
  
  p <- ggplot(sample[sample$enhancer != "NEG_CTRL",], aes(x = reorder(x = enhancer, X = log2(CPMNorm.FC), FUN=median), y = log2(CPMNorm.FC), fill = phenotype)) +
        geom_point(size = 3, aes(shape = sample[sample$enhancer != "NEG_CTRL","pch"], color = ifelse(padj < 0.05, "<0.05",">=0.05"))) +
        theme(panel.background = element_blank(),
              panel.grid = element_blank(),
              axis.text = element_text(color = "black", size = 7.2),
              axis.text.y = element_text(size = 8.5),
              axis.text.x = element_text(angle = 60, hjust = 1),
              axis.title = element_text(size = 9),
              legend.key = element_blank(),
              legend.title = element_text(size = 7),
              legend.text = element_text(size = 7),
              legend.key.size = unit(0.8,"line")) +
        scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
        scale_shape_manual(values = c(22,21,23)) +
        scale_color_manual(values = c('black', 'grey80')) +
        ggtitle(label = paste0(i)) +
        labs(x = "Enhancers", y = "Log2 FC", color = "Adjusted\np-value", fill = "Enhancer\nPhenotype", shape = NULL)
  ggsave(filename = paste0("Plots/Activity_per_line/5p/CHEQseq_5p_Enhancers_expression_",i,"_with_shapesMES.pdf"), device = "pdf",width = 7,height = 3, useDingbats = F)
  print(p)
  
  p <- ggplot(sample, aes(x = padj, y = log2(CPMNorm.FC), fill = phenotype)) +
        geom_point(pch = 21, size = 3) +
        geom_vline(xintercept = 0.05, linetype="dashed", color = "black", size = 0.5) +
        theme(panel.background = element_blank(),
              panel.grid = element_blank(),
              axis.text = element_text(color = "black", size = 7),
              axis.title = element_text(size = 8),
              legend.key = element_blank(),
              legend.title = element_text(size = 7),
              legend.text = element_text(size = 7),
              legend.key.size = unit(0.8,"line")) +
        scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
        ggtitle(label = paste0(i)) +
        labs(x = "Adjusted p-value", y = "Log2 FC", color = "Adjusted\np-value", fill = "Enhancer\nPhenotype")
  print(p)
}
# Save env
saveRDS(object = CH1.5p, file = "data/CHEQseq__5p__R_environment.RDS")
```

# Correlation between lines
```{r}
library(dplyr)
CH1.5p.df <- CH1.5p$MM001$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC")] %>%
              full_join(CH1.5p$MM057$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC")], by = "enhancer") %>%
              full_join(CH1.5p$MM074$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC")], by = "enhancer") %>% 
              full_join(CH1.5p.87.df[,c("enhancer", "mean.CPMNorm.FC")], by = "enhancer") %>%
              full_join(CH1.5p$MM029$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC")], by = "enhancer") %>%
              full_join(CH1.5p$MM047$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC")], by = "enhancer") %>%
              full_join(CH1.5p$MM099$merged.cpm.input.norm[,c("enhancer", "CPMNorm.FC", "phenotype")], by = "enhancer")
colnames(CH1.5p.df) <- c("enhancer", "MM001.CPMNorm.FC", "MM057.CPMNorm.FC", "MM074.CPMNorm.FC", "MM087.CPMNorm.FC", "MM029.CPMNorm.FC", "MM047.CPMNorm.FC", "MM099.CPMNorm.FC", "phenotype")
CH1.5p.df$Switcher.CPMNorm.FC <- rowMeans(CH1.5p.df[,c(3:5)])
CH1.5p.df$Inv.CPMNorm.FC <- rowMeans(CH1.5p.df[,c(6:8)])
CH1.5p.df <- CH1.5p.df[CH1.5p.df$enhancer != "NEG_CTRL",]
# Save df
saveRDS(object = CH1.5p.df, file = "data/CHEQseq__5p__combined_dataframe.RDS")
```

# Percentage of active enhancer per cell line
```{r}
library(ggplot2)
library(reshape2)
library(scales)
rename.columns <- function(df, new.colnames = c("enhancer","phenotype", "padj")) {
  colnames(x = df) <- new.colnames
  return (df)
}

m <- rbind(cbind(rename.columns(df = CH1.5p[["MM001"]]$merged.cpm.input.norm[,c("enhancer","phenotype", "padj")]), data.frame("MM.line"=rep("MM001",nrow(CH1.5p[["MM001"]]$merged.cpm.input.norm))))
           , cbind(rename.columns(df = CH1.5p[["MM057"]]$merged.cpm.input.norm[,c("enhancer","phenotype", "padj")]), data.frame("MM.line"=rep("MM057",nrow(CH1.5p[["MM057"]]$merged.cpm.input.norm))))
           , cbind(rename.columns(df = CH1.5p[["MM074"]]$merged.cpm.input.norm[,c("enhancer","phenotype", "padj")]), data.frame("MM.line"=rep("MM074",nrow(CH1.5p[["MM074"]]$merged.cpm.input.norm))))
           , cbind(rename.columns(df = CH1.5p[["MM087"]]$merged.cpm.input.norm[,c("enhancer","phenotype", "padj")]), data.frame("MM.line"=rep("MM087",nrow(CH1.5p[["MM087"]]$merged.cpm.input.norm))))
           , cbind(rename.columns(df = CH1.5p[["MM029"]]$merged.cpm.input.norm[,c("enhancer","phenotype", "padj")]), data.frame("MM.line"=rep("MM029",nrow(CH1.5p[["MM029"]]$merged.cpm.input.norm))))
           , cbind(rename.columns(df = CH1.5p[["MM047"]]$merged.cpm.input.norm[,c("enhancer","phenotype", "padj")]), data.frame("MM.line"=rep("MM047",nrow(CH1.5p[["MM047"]]$merged.cpm.input.norm))))
           , cbind(rename.columns(df = CH1.5p[["MM099"]]$merged.cpm.input.norm[,c("enhancer","phenotype", "padj")]), data.frame("MM.line"=rep("MM099",nrow(CH1.5p[["MM099"]]$merged.cpm.input.norm))))
)
# df <- melt(m, id = c("enhancer","phenotype"))

# Plot number of 'active' enhancers in all MM lines and split per prol and inv
bin <- m
bin$value <- ifelse(m$padj < 0.05,1,0) # Selected enhancers with 10% higher activity than basal activity
library(dplyr)
bin <- filter(bin, value == 1)

# Plot percentage of 'active' enhancers (ie. log2FC >= 1) in each of the MM lines and split per prol and inv
tab <- as.data.frame(table(bin$MM.line, bin$phenotype))
tab$Perc[tab$Var2 == 'Invasive'] <- tab$Freq[tab$Var2 == 'Invasive']/c(24,22,22,22,23,23,25)
tab$Perc[tab$Var2 == 'Proliferative'] <- tab$Freq[tab$Var2 == 'Proliferative']/c(12,10,12,11,12,11,12)
tab <- tab[,-3]
colnames(tab) <- c('Line','phenotype','Perc')
ggplot(tab, aes(x=Line, y=Perc, fill=phenotype)) +
  geom_bar(stat='identity', position = "dodge", width = 0.8, color = "black", size = 0.25) +
  theme(panel.background = element_rect(fill = "white", colour = "white", size = 0.5),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major = element_line(size = 0.25, linetype = 'solid', colour = "black"),
        axis.ticks = element_line(colour = "black", size = 0.25),
        axis.text=element_text(colour="black", size = 7),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        legend.key = element_rect(fill = "white"),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        legend.key.size = unit(0.8,"line")) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_x_discrete(labels= c("MM001", "MM057", "MM074", "MM087", "MM029", "MM047", "MM099")) +
  scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  labs(x = "Line", y = "Percentage of active enhancers", fill = "Enhancer \nphenotype")
ggsave(filename = paste0("Plots/CHEQseq_5p_percent_active_dodge.pdf"),device = "pdf",width = 4,height = 3)

library(tidyverse)
library(ggplot2)
act.sum <- data.frame(Enhancer = factor(), 
                      Phenotype = factor(), 
                      Lines = factor(), 
                      Count = double())
for (i in CH1.5p.df$enhancer){
  count <- sum(bin[bin$enhancer == i & bin$MM.line %in% c("MM001", "MM057", "MM074", "MM087"),"value"])
  act.sum <- add_row(.data = act.sum,
                     Enhancer = i, 
                     Phenotype = CH1.5p.df[CH1.5p.df$enhancer == i, "phenotype"], 
                     Lines = "MEL", 
                     Count = count)
  count <- sum(bin[bin$enhancer == i & bin$MM.line %in% c("MM029", "MM047", "MM099"),"value"])
  act.sum <- add_row(.data = act.sum,
                     Enhancer = i, 
                     Phenotype = CH1.5p.df[CH1.5p.df$enhancer == i, "phenotype"], 
                     Lines = "MES", 
                     Count = count)
}

# Count proportion of enhancer active per number of line
## Number of enhancer per phenotype
nrow.mel <- nrow(act.sum[act.sum$Lines == "MEL" & act.sum$Phenotype == "Proliferative",])
nrow.mes <- nrow(act.sum[act.sum$Lines == "MES" & act.sum$Phenotype == "Invasive",])
## Proportion for each condition
mel.1 <- nrow(act.sum[act.sum$Lines == "MEL" & act.sum$Phenotype == "Proliferative" & act.sum$Count == 1,])/nrow.mel
mel.2 <- nrow(act.sum[act.sum$Lines == "MEL" & act.sum$Phenotype == "Proliferative" & act.sum$Count == 2,])/nrow.mel
mel.3 <- nrow(act.sum[act.sum$Lines == "MEL" & act.sum$Phenotype == "Proliferative" & act.sum$Count == 3,])/nrow.mel
mel.4 <- nrow(act.sum[act.sum$Lines == "MEL" & act.sum$Phenotype == "Proliferative" & act.sum$Count == 4,])/nrow.mel
mes.1 <- nrow(act.sum[act.sum$Lines == "MES" & act.sum$Phenotype == "Invasive" & act.sum$Count == 1,])/nrow.mes
mes.2 <- nrow(act.sum[act.sum$Lines == "MES" & act.sum$Phenotype == "Invasive" & act.sum$Count == 2,])/nrow.mes
mes.3 <- nrow(act.sum[act.sum$Lines == "MES" & act.sum$Phenotype == "Invasive" & act.sum$Count == 3,])/nrow.mes
## Combine data into dataframe
act.per <- data.frame(Lines = c("MEL", "MEL", "MEL", "MEL", "MES", "MES", "MES"), Count = as.factor(c("MEL 1","MEL 2","MEL 3","MEL 4","MES 1","MES 2","MES 3")), Percentage = c(mel.1, mel.2, mel.3, mel.4, mes.1, mes.2, mes.3))

ggplot(act.per, aes(x=Lines, y=Percentage, fill=Count)) +
  geom_bar(stat='identity', width = 0.8, color = "black", size = 0.25) +
  theme(panel.background = element_rect(fill = "white", colour = "white", size = 0.5),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major = element_line(size = 0.25, linetype = 'solid', colour = "black"),
        axis.ticks = element_line(colour = "black", size = 0.25),
        axis.text=element_text(colour="black", size = 7),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        legend.key = element_rect(fill = "white"),
        legend.title = element_text(size = 7),
        legend.text = element_text(size = 7),
        legend.key.size = unit(0.8,"line")) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("#7099CA", "#4F87CA", "#1C5395", "#2C4B70", "#F25151", "#E41A1A", "#AB3939"), labels = c("1 MEL line", "2 MEL lines", "3 MEL lines", "4 MEL lines", "1 MES line", "2 MES lines", "3 MES lines")) +
  labs(x = "Enhancers", y = "Percentage of active enhancers", fill = "MEL enhancer \nactive in:")
ggsave(filename = paste0("Plots/CHEQseq_5p_active_summary.pdf"),device = "pdf", width = 2.75, height = 3)
```

# One vs One
```{r}
library(Hmisc)
for (i in c("MM029", "MM047", "MM057", "MM074", "MM087", "MM099")) {
p<-ggplot(CH1.5p.df, aes(x = log2(MM001.CPMNorm.FC), y = log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]), color = phenotype)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(CH1.5p.df[,"MM001.CPMNorm.FC"]),na.rm = T), y = max(log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), label = paste0("r = ", round(cor(log2(na.omit(CH1.5p.df[,c("MM001.CPMNorm.FC",paste0(i,".CPMNorm.FC"))])), method="pearson")[1,2], digits = 4)), hjust = 0) +
  labs(x = "MM001 Log2 Expression", y = paste0(i," Log2 Expression"), color = "Enhancer\nphenotype", title = paste0("Correlation MM001 vs ",i," - CHEQseq 5p"))
ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_MM001vs",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
for (i in c("MM047", "MM057", "MM074", "MM087", "MM099")) {
p<-ggplot(CH1.5p.df, aes(x = log2(MM029.CPMNorm.FC), y = log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]), color = phenotype)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(CH1.5p.df[,"MM029.CPMNorm.FC"]),na.rm = T), y = max(log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), label = paste0("r = ", round(cor(log2(na.omit(CH1.5p.df[,c("MM029.CPMNorm.FC",paste0(i,".CPMNorm.FC"))])), method="pearson")[1,2], digits = 4)), hjust = 0) +  labs(x = "MM029 Log2 Expression", y = paste0(i," Log2 Expression"), color = "Enhancer\nphenotype", title = paste0("Correlation MM029 vs ",i," - CHEQseq 5p"))
ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_MM029vs",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
for (i in c("MM057", "MM074", "MM087", "MM099")) {
p<-ggplot(CH1.5p.df, aes(x = log2(MM047.CPMNorm.FC), y = log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]), color = phenotype)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(CH1.5p.df[,"MM047.CPMNorm.FC"]),na.rm = T), y = max(log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), label = paste0("r = ", round(cor(log2(na.omit(CH1.5p.df[,c("MM047.CPMNorm.FC",paste0(i,".CPMNorm.FC"))])), method="pearson")[1,2], digits = 4)), hjust = 0) +
  labs(x = "MM047 Log2 Expression", y = paste0(i," Log2 Expression"), color = "Enhancer\nphenotype", title = paste0("Correlation MM047 vs ",i," - CHEQseq 5p"))
ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_MM047vs",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
for (i in c("MM074", "MM087", "MM099")) {
p<-ggplot(CH1.5p.df, aes(x = log2(MM057.CPMNorm.FC), y = log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]), color = phenotype)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(CH1.5p.df[,"MM057.CPMNorm.FC"]),na.rm = T), y = max(log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), label = paste0("r = ", round(cor(log2(na.omit(CH1.5p.df[,c("MM057.CPMNorm.FC",paste0(i,".CPMNorm.FC"))])), method="pearson")[1,2], digits = 4)), hjust = 0) +
  labs(x = "MM057 Log2 Expression", y = paste0(i," Log2 Expression"), color = "Enhancer\nphenotype", title = paste0("Correlation MM057 vs ",i," - CHEQseq 5p"))
ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_MM057vs",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
for (i in c("MM087", "MM099")) {
p<-ggplot(CH1.5p.df, aes(x = log2(MM074.CPMNorm.FC), y = log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]), color = phenotype)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(CH1.5p.df[,"MM074.CPMNorm.FC"]),na.rm = T), y = max(log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), label = paste0("r = ", round(cor(log2(na.omit(CH1.5p.df[,c("MM074.CPMNorm.FC",paste0(i,".CPMNorm.FC"))])), method="pearson")[1,2], digits = 4)), hjust = 0) +
  labs(x = "MM074 Log2 Expression", y = paste0(i," Log2 Expression"), color = "Enhancer\nphenotype", title = paste0("Correlation MM074 vs ",i," - CHEQseq 5p"))
ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_MM074vs",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
for (i in c("MM099")) {
p<-ggplot(CH1.5p.df, aes(x = log2(MM087.CPMNorm.FC), y = log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]), color = phenotype)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(CH1.5p.df[,"MM087.CPMNorm.FC"]),na.rm = T), y = max(log2(CH1.5p.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), label = paste0("r = ", round(cor(log2(na.omit(CH1.5p.df[,c("MM087.CPMNorm.FC",paste0(i,".CPMNorm.FC"))])), method="pearson")[1,2], digits = 4)), hjust = 0) +
  labs(x = "MM087 Log2 Expression", y = paste0(i," Log2 Expression"), color = "Enhancer\nphenotype", title = paste0("Correlation MM087 vs ",i," - CHEQseq 5p"))
ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_MM087vs",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
```

# MM087 rep correlations
```{r}
library(Hmisc)
library(dplyr)
for (i in c("MM087_rep2", "MM087_rep3")) {
  tmp <- inner_join(CH1.5p$MM087_rep1$merged.cpm.input.basal.norm[, c("enhancer", "BasalNorm.FC")],
                    CH1.5p[[i]]$merged.cpm.input.basal.norm, by = "enhancer", suffix = c("_MM087_rep1", paste0("_",i)))
p<-ggplot(tmp, aes(x = log2(BasalNorm.FC_MM087_rep1), y = log2(tmp[,paste0("BasalNorm.FC_",i)]), color = phenotype)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(tmp[,"BasalNorm.FC_MM087_rep1"]),na.rm = T), y = max(log2(tmp[,paste0("BasalNorm.FC_",i)]),na.rm = T), label = paste0("r (log2)= ", round(cor(log2(na.omit(tmp[,c("BasalNorm.FC_MM087_rep1",paste0("BasalNorm.FC_",i))])), method="pearson")[1,2], digits = 4)), hjust = 0) +
  annotate("text", x = min(log2(tmp[,"BasalNorm.FC_MM087_rep1"]),na.rm = T), y = max(log2(tmp[,paste0("BasalNorm.FC_",i)]),na.rm = T)-1, label = paste0("r = ", round(cor(na.omit(tmp[,c("BasalNorm.FC_MM087_rep1",paste0("BasalNorm.FC_",i))]), method="pearson")[1,2], digits = 4)), hjust = 0) +
  labs(x = "MM001 Log2 Expression", y = paste0(i," Log2 Expression"), color = "Enhancer\nphenotype", title = paste0("Correlation MM001 vs ",i," - CHEQseq 5p"))
#ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_MM001vs",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
```


```{r}
ggplot(CH1.5p.df, aes(x = log2(Switcher.CPMNorm.FC), y = log2(Inv.CPMNorm.FC), color = phenotype, label = enhancer)) +
  geom_point() +
  geom_smooth(method = "lm", alpha = 0.1) +
  geom_text(data = subset(CH1.5p.df, Switcher.CPMNorm.FC >= 1 | Inv.CPMNorm.FC >= 1), check_overlap = F, vjust = 0, nudge_y = 0.1, size = 2.2) +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  labs(x = "Intermediate Log2 FC", y = "MES-like Log2 FC", color = "Enhancer\nphenotype", title = "Correlation Intermediate vs MES-like - CHEQseq 5p")
ggsave(filename = paste0("Plots/Correlation/5p/CHEQseq_5p_correlation_IntermediatevsMES.pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
```

```{r}
cor(CH1.5p.df[CH1.5p.df$phenotype == "Invasive", c("MM001.CPMNorm.FC","Switcher.CPMNorm.FC", "Inv.CPMNorm.FC")], method = "pearson", use = "pairwise.complete.obs")
cor(CH1.5p.df[CH1.5p.df$phenotype == "Proliferative", c("MM001.CPMNorm.FC","Switcher.CPMNorm.FC", "Inv.CPMNorm.FC")], method = "pearson", use = "pairwise.complete.obs")
```


# Correlation table (FC)
```{r}
library(corrplot)
M <- cor(x = CH1.5p.df[,c(2:8)], method = "pearson", use = "pairwise.complete.obs")
colnames(M) <- c("MM001", "MM057", "MM074", "MM087", "MM029", "MM047", "MM099")
row.names(M) <- c("MM001", "MM057", "MM074", "MM087", "MM029", "MM047", "MM099")
setEPS()
postscript(file = paste0("Plots/Correlation/CorrClustBasal_5p_bc5.eps"), 
           horizontal = FALSE, onefile = FALSE, paper = "special", height = 7, width = 7)
corrplot(M, method="color", addCoef.col = "grey", tl.col="black", title = "CHEQseq 5p CPM normalised", order = "hclust", addrect = 2, mar = c(0, 0, 1.5, 0))
dev.off()
```

# Correlation table (log2 FC)
```{r}
library(corrplot)
M <- cor(x = log2(CH1.5p.df[,c(2:8)]), method = "pearson", use = "pairwise.complete.obs")
colnames(M) <- c("MM001", "MM057", "MM074", "MM087", "MM029", "MM047", "MM099")
row.names(M) <- c("MM001", "MM057", "MM074", "MM087", "MM029", "MM047", "MM099")
setEPS()
postscript(file = paste0("Plots/Correlation/CorrClustBasal_5p_bc5_log.eps"), 
           horizontal = FALSE, onefile = FALSE, paper = "special", height = 7, width = 7)
corrplot(M, method="color", addCoef.col = "grey", tl.col="black", title = "CHEQseq 5p CPM normalised", order = "hclust", addrect = 2, mar = c(0, 0, 1.5, 0))
dev.off()
```

# Correlation table (log2 FC)
```{r}
library(corrplot)
M <- cor(x = log2(CH1.5p.df[,c(2:8)]), method = "spearman", use = "pairwise.complete.obs")
colnames(M) <- c("MM001", "MM057", "MM074", "MM087", "MM029", "MM047", "MM099")
row.names(M) <- c("MM001", "MM057", "MM074", "MM087", "MM029", "MM047", "MM099")
setEPS()
postscript(file = paste0("Plots/Correlation/CorrClustBasal_5p_bc5_spearman.eps"), 
           horizontal = FALSE, onefile = FALSE, paper = "special", height = 7, width = 7)
corrplot(M, method="color", addCoef.col = "grey", tl.col="black", title = "CHEQseq 5p CPM normalised", order = "hclust", addrect = 2, mar = c(0, 0, 1.5, 0))
dev.off()
```

# Correlation table per phenotype
```{r}
library(corrplot)
setEPS()
postscript(file = "Plots/Correlation/CorrClustBasal3_5p_pheno.eps", 
           horizontal = FALSE, onefile = FALSE, paper = "special", height = 7, width = 7)
M <- cor(x = CH1.5p.df[,c(2,10,11)], method = "pearson", use = "pairwise.complete.obs")
colnames(M) <- c("MM001", "Intermediate", "MES")
row.names(M) <- c("MM001", "Intermediate", "MES")
corrplot(M, method="color", addCoef.col = "grey60", tl.col="black", title = "CHEQseq 5' CPM normalised", addrect = 2)
dev.off()
```


## Correlation 5p and Intron combined
```{r}
CH1.df <- full_join(x = CH1.5p.df, 
                    y = CH1.intron.df, 
                    by = "enhancer", 
                    suffix = c(".5p", ".intron"))
# Save df
saveRDS(object = CH1.df, file = "data/CHEQseq__5pvsIntron__combined_dataframe.RDS")
library(corrplot)
M <- cor(x = CH1.df[,c(2:8,12:18)], method = "pearson", use = "pairwise.complete.obs")
colnames(M) <- c("MM001.5p", "MM057.5p", "MM074.5p", "MM087.5p", "MM029.5p", "MM047.5p", "MM099.5p", "MM001.intron", "MM057.intron", "MM074.intron", "MM087.intron", "MM029.intron", "MM047.intron", "MM099.intron")
row.names(M) <- c("MM001.5p", "MM057.5p", "MM074.5p", "MM087.5p", "MM029.5p", "MM047.5p", "MM099.5p", "MM001.intron", "MM057.intron", "MM074.intron", "MM087.intron", "MM029.intron", "MM047.intron", "MM099.intron")
setEPS()
postscript(file = "Plots/Correlation/Interassay_correlation/CorrClustBasal_5p_bc3vsIntron.eps", 
           horizontal = FALSE, onefile = FALSE, paper = "special", height = 9, width = 9)
corrplot(M, method="color", addCoef.col = "grey", tl.col="black", title = "CHEQseq 5p vs Intron - Basal normalised", order = "hclust", addrect = 2)
dev.off()
```

```{r}
library(corrplot)
M <- cor(x = CH1.df[,c(2,10:12,20:21)], method = "pearson", use = "pairwise.complete.obs")
colnames(M) <- c("MM001.5p", "Switchers.5p", "MES.5p", "MM001.intron", "Switcher.intron", "MES.intron")
row.names(M) <- c("MM001.5p", "Switchers.5p", "MES.5p", "MM001.intron", "Switcher.intron", "MES.intron")
corrplot(M, method="color", addCoef.col = "grey", tl.col="black", title = "Phenotype CHEQseq 5p vs Intron", order = "hclust", addrect = 2)
```


# Correlation accross assay
```{r}
library(ggplot2)
for (i in c("MM001","MM029", "MM047", "MM057", "MM074", "MM087", "MM099", "Switcher", "Inv")) {
  a <- cor.test(log2(CH1.df[,paste0(i,".CPMNorm.FC")]), log2(CH1.df[,paste0(i,".BasalNorm.FC")]), method="pearson")
  b <- cor.test(log2(CH1.df[,paste0(i,".CPMNorm.FC")]), log2(CH1.df[,paste0(i,".BasalNorm.FC")]), method="spearman")
p<-ggplot(CH1.df, aes(x = log2(CH1.df[,paste0(i,".CPMNorm.FC")]), y = log2(CH1.df[,paste0(i,".BasalNorm.FC")]), color = phenotype.5p)) +
  geom_smooth(method = "lm", alpha =0.1) +
  geom_point() +
  theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black")) +
  scale_color_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
  annotate("text", x = min(log2(CH1.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), y = max(log2(CH1.df[,paste0(i,".BasalNorm.FC")]),na.rm = T), label = paste0("Pearson's r = ", round(a[["estimate"]][["cor"]], digits = 4)), hjust = 0) +
  annotate("text", x = min(log2(CH1.df[,paste0(i,".CPMNorm.FC")]),na.rm = T), y = max(log2(CH1.df[,paste0(i,".BasalNorm.FC")]),na.rm = T)-0.5, label = paste0("Spearman's rho = ", round(b[["estimate"]][["rho"]], digits = 4)), hjust = 0) +
  labs(x = "CHEQ-seq 5' Log2 FC", y = "CHEQ-seq Intron Log2 FC", color = "Enhancer\nphenotype", title = i)
ggsave(filename = paste0("Plots/Correlation/Interassay_correlation/CHEQseq_assay_correlation_",i,".pdf"),device = "pdf",width = 5,height = 4, useDingbats = F)
print(p)
}
```


# Analysis on all MM lines
```{r}
rename.columns <- function(df, new.colnames = c("enhancer","CPMNorm.FC", "phenotype","pvalue","padj")) {
  colnames(x = df) <- new.colnames
  return (df)
}
MM.5p.df<-rbind(cbind(rename.columns(df = CH1.5p[["MM001"]]$merged.cpm.input.norm[,c(1,4:7)]), data.frame("MM.line"=rep("MM001",nrow(CH1.5p[["MM001"]]$merged.cpm.input.norm[,c(1,4:7)]))))
               , cbind(rename.columns(df = CH1.5p[["MM057"]]$merged.cpm.input.norm[,c(1,4:7)]), data.frame("MM.line"=rep("MM057",nrow(CH1.5p[["MM057"]]$merged.cpm.input.norm[,c(1,4:7)]))))
               , cbind(rename.columns(df = CH1.5p[["MM074"]]$merged.cpm.input.norm[,c(1,4:7)]), data.frame("MM.line"=rep("MM074",nrow(CH1.5p[["MM074"]]$merged.cpm.input.norm[,c(1,4:7)]))))
               , cbind(rename.columns(df = CH1.5p[["MM087"]]$merged.cpm.input.norm), data.frame("MM.line"=rep("MM087",nrow(CH1.5p[["MM087"]]$merged.cpm.input.norm))))
               , cbind(rename.columns(df = CH1.5p[["MM029"]]$merged.cpm.input.norm[,c(1,4:7)]), data.frame("MM.line"=rep("MM029",nrow(CH1.5p[["MM029"]]$merged.cpm.input.norm[,c(1,4:7)]))))
               , cbind(rename.columns(df = CH1.5p[["MM047"]]$merged.cpm.input.norm[,c(1,4:7)]), data.frame("MM.line"=rep("MM047",nrow(CH1.5p[["MM047"]]$merged.cpm.input.norm[,c(1,4:7)]))))
               , cbind(rename.columns(df = CH1.5p[["MM099"]]$merged.cpm.input.norm[,c(1,4:7)]), data.frame("MM.line"=rep("MM099",nrow(CH1.5p[["MM099"]]$merged.cpm.input.norm[,c(1,4:7)]))))
)
MM.5p.df$enhancer <- factor(MM.5p.df$enhancer)
```

# Expression per enhancer
```{r}
library(ggplot2)
for(i in levels(MM.5p.df$enhancer)) {
 p<- ggplot(MM.5p.df[MM.5p.df$enhancer==i,], aes(x=MM.line, y=log2(CPMNorm.FC), group=MM.line, fill = phenotype)) + 
    geom_point(pch = 21, size = 5, stroke = 1.5, aes(color = ifelse(padj < 0.05,'grey80', 'black'))) +
    theme(panel.background = element_blank(),
          panel.grid = element_blank(),
          axis.title.y = element_text(size=9),
          legend.key = element_rect(fill = "white"),
          axis.text = element_text(color = "black"),
          axis.title.x = element_blank()) +
    scale_fill_manual(values = ifelse(MM.5p.df[MM.5p.df$enhancer==i,"phenotype"] == "Invasive",'#E41A1C','#1C5395'), labels = i) +
    scale_color_manual(values = c('grey80', 'black'), labels = c(">= 0.05", "< 0.05")) +
    scale_x_discrete(drop=FALSE) +
    labs(y = "Log2 FC", fill = "Enhancer", color = "Adjusted\np-value")
 print(p)
ggsave(filename = paste0("Plots/Activity_per_enhancer/5p/CHEQseq_5p_",i,"_activity.pdf"),device = "pdf",width = 5,height = 2.5)
}
```

# Expression range violin plot
```{r}
library(ggplot2)
ggplot(MM.5p.df, aes(x=MM.line, y=log(CPMNorm.FC), fill=phenotype)) + 
    geom_violin(draw_quantiles = 0.5) +
    geom_point(data = MM.5p.df[MM.5p.df$padj >=0.05,], pch = 21, position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.9), aes(color = ifelse(padj < 0.05,'grey80', 'black'))) +
    geom_point(data = MM.5p.df[MM.5p.df$padj <0.05,], pch = 21, position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.9), aes(color = ifelse(padj < 0.05,'grey80', 'black'))) +
    theme(panel.background = element_blank(),
          panel.grid = element_blank(),
          legend.key = element_rect(fill = "white"),
          axis.text = element_text(color = "black"),
          axis.title.x=element_blank()) +
    scale_color_manual(values = c('grey80', 'black'), labels = c(">= 0.05", "< 0.05")) +
    scale_fill_manual(values = c("#E41A1C", "#377EB8"), labels = c("MES", "MEL")) +
    labs(y = "Log2 FC", fill = "Enhancer \nphenotype", title = "CHEQseq 5' - Expression range", color = "Adjusted\np-value")
ggsave(filename = "Plots/CHEQseq_5p_Expression_range_violin.pdf",device = "pdf",width = 7,height = 5.5)
```

# Per cell line phenotype
```{r}
rename.columns <- function(df, new.colnames = c("enhancer", "CPMNorm.FC", "phenotype")) {
  colnames(x = df) <- new.colnames
  return (df)
}
MM.5P.pheno.df<-rbind(cbind(rename.columns(df = CH1.5p.df[,c(1,2,9)]), data.frame("Cell.phenotype"= "MM001")),
                      cbind(rename.columns(df = CH1.5p.df[,c(1,10,9)]), data.frame("Cell.phenotype"= "Switcher")),
                      cbind(rename.columns(df = CH1.5p.df[,c(1,11,9)]), data.frame("Cell.phenotype"= "MES-like")))
```

```{r}
library(ggplot2)
ggplot(na.omit(MM.5P.pheno.df), aes(x=Cell.phenotype, y=log2(CPMNorm.FC), fill=phenotype)) + 
    geom_violin() +
    geom_point(pch = 21, position = position_jitterdodge(jitter.width = 0.15, dodge.width = 0.9)) +
    theme(panel.background = element_blank(),
        panel.grid = element_blank(),
        legend.key = element_rect(fill = "white"),
        axis.text = element_text(color = "black"),
        axis.title.x=element_blank()) +
    geom_hline(yintercept=log(1), linetype="dashed", color = "black", size = 0.5) +
    labs(fill = "Enhancer \nphenotype") +
    scale_fill_manual(values = c("#E41A1C", "#377EB8")) +
    ggtitle(label = "CHEQseq 5' - Expression range") +
    labs(y = "Log2 FC")
#ggsave(filename = "Plots/CHEQseq_5p_Expression_range_violin.eps",device = "eps",width = 11.69,height = 8.27)
```

```{r}
library(reshape2)
enhancer.vs.MM<-dcast(data = MM.5p.df, formula = enhancer ~ MM.line, fun.aggregate = mean, value.var = "CPMNorm.FC")
row.names(enhancer.vs.MM)<-enhancer.vs.MM$enhancer
enhancer.vs.MM<-enhancer.vs.MM[, -c(1)]
```

```{r}
library(gplots)
library(RColorBrewer)
enhancer.vs.MM.scaled<-t(scale(x = t(enhancer.vs.MM)))
colfunc <- colorRampPalette(c("#005BC4", "white", "#A8202C"))
heat5p <- heatmap.2(as.matrix(na.omit(enhancer.vs.MM.scaled)), col = colfunc(50), tracecol = "black")

setEPS()
postscript(file = "Plots/CHEQseq_5p_heatmap_zscore.eps", 
           horizontal = FALSE, onefile = FALSE, paper = "special", height = 8.27, width = 10)
heatmap.2(as.matrix(na.omit(enhancer.vs.MM.scaled)), col = colfunc(50), tracecol = "black", margins = c(5,7.6))
dev.off()
```

```{r}
library(gplots)
library(viridis)
setEPS()
postscript(file = "Plots/CHEQseq_5p_heatmap_cpm.eps", 
           horizontal = FALSE, onefile = FALSE, paper = "special", height = 8.27, width = 10)
heatmap.2(as.matrix(log2(na.omit(enhancer.vs.MM)[rev(heat5p$rowInd),heat5p$colInd])), Rowv = F, Colv = F, col = inferno(50), tracecol = "darkgrey", dendrogram = "none", margins = c(5,7.6))
dev.off()
```

```{r}
save.image(file = "5pP_count.RData", compress = TRUE)
```

```{r}
library(robustbase)
# Give activity score
control.enhancers <- c("MAP3K14_-2-D","BLK_21-I","BLK_22-I","ALPK2_49-E","BDNF_P", "SMURF2_-47-D","MITF_P", "GPM6B_P", "SOX10_15-3U")
proliferative.enhancers <- c("CDH1_24-I","CDH1_49-I","SOX10_15-3U","SOX10_-3-D","SOX10_-34-D","SOX10_-35-D","SOX10_-56-D","IRF4_4-I","GPM6B_P","KIT_114-D","MLANA_5-I","SGCD_15-I","SGCD_26-I","MITF_P","TYR_-9-D","TYR_-1-D","TYR_P","RRAGD_P")
enhancer.vs.MM <- as.matrix(enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% control.enhancers,])
# Calculate ratios
score.median <- colMedians(na.omit(enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% proliferative.enhancers,])) / colMedians(na.omit(enhancer.vs.MM[rownames(enhancer.vs.MM) %in% proliferative.enhancers,]))
score.mean <- colMeans(na.omit(enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% proliferative.enhancers,])) / colMeans(na.omit(enhancer.vs.MM[rownames(enhancer.vs.MM) %in% proliferative.enhancers,]))
# Create dataframes
FP.enhancer.score.activity.median <- data.frame(Activity = score.median, MM_line = names(score.median), library = "CHEQ-seq 5' H3K27ac")
FP.enhancer.score.activity.mean <- data.frame(Activity = score.mean, MM_line = names(score.mean), library = "CHEQ-seq 5' H3K27ac")
# Save
saveRDS(object = FP.enhancer.score.activity.median, file = "data/CHEQseq__5p__score_activity_median.rds")
saveRDS(object = FP.enhancer.score.activity.mean, file = "data/CHEQseq__5p__score_activity_mean.rds")
# Combine values from 5' and Intron
enhancer.score.activity <- rbind(IP.enhancer.score.activity.mean,FP.enhancer.score.activity.mean)
```

```{r}
library(ggplot2)
# Plot with median
ggplot(FP.enhancer.score.activity.median, aes(x=reorder(x = MM_line, X = log2(Activity)), y=log2(Activity), fill=MM_line)) + 
    geom_bar(stat='identity', width = 0.8, color = "black", size = 0.25) +
    theme(panel.background = element_rect(fill = "white", colour = "white", size = 0.5),
          panel.grid = element_blank(),
          axis.title.x=element_blank(),
          axis.text = element_text(color = "black"),
          axis.title.y = element_text(size = 9),
          legend.key = element_blank()) +
    scale_fill_manual(values = c("#377EB8", "#E41A1C", "#E41A1C", "#377EB8",  "#377EB8",  "#377EB8", "#E41A1C")) +
    scale_x_discrete(drop=FALSE) +
    labs(y = "Log2 Activity Ratio", color = "Line phenotype")
ggsave(filename = "Plots/CHEQseq_5p_Activity_score_median.pdf",device = "pdf",width = 5,height = 3)

# Plot with mean
ggplot(FP.enhancer.score.activity.mean, aes(x=reorder(x = MM_line, X = log2(Activity)), y=log2(Activity), fill=MM_line)) + 
    geom_bar(stat='identity', width = 0.8, color = "black", size = 0.25) +
    theme(panel.background = element_rect(fill = "white", colour = "white", size = 0.5),
          panel.grid = element_blank(),
          axis.title.x=element_blank(),
          axis.text = element_text(color = "black"),
          axis.title.y = element_text(size = 9),
          legend.key = element_blank()) +
    scale_fill_manual(values = c("#377EB8", "#E41A1C", "#E41A1C", "#377EB8",  "#377EB8",  "#377EB8", "#E41A1C")) +
    scale_x_discrete(drop=FALSE) +
    labs(y = "Log2 Activity Ratio", color = "Line phenotype")
ggsave(filename = "Plots/CHEQseq_5p_Activity_score_mean.pdf",device = "pdf",width = 5,height = 3)
```

## Calculate significance MEL vs MES activity ratio
### Define if data is normal
```{r}
# Shapiro-Wilk normality test for MEL enhancers values
shapiro.test(as.matrix(enhancer.vs.MM[rownames(enhancer.vs.MM) %in% proliferative.enhancers,])) # < 2.2e-16
# Shapiro-Wilk normality test for MES enhancers values
shapiro.test(as.matrix(enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% proliferative.enhancers,])) # < 2.2e-16
```

# t tests
```{r}
# t test on ratio values
print("Ratio with median")
t.test(FP.enhancer.score.activity.median[c(5:7),"Activity"], FP.enhancer.score.activity.median[c(1:4),"Activity"], alternative = "greater")$p.value
print("Ratio with mean")
t.test(FP.enhancer.score.activity.mean[c(5:7),"Activity"], FP.enhancer.score.activity.mean[c(1:4),"Activity"], alternative = "greater")$p.value

# t-test per state (pooled MES values vs MEL values)
## MEL state
x.mel <- c()
y.mel <- c()
for (i in c("MM001", "MM057", "MM074", "MM087")){
  x.mel <- c(x.mel, enhancer.vs.MM[rownames(enhancer.vs.MM) %in% proliferative.enhancers,i])
  y.mel <- c(y.mel, enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% proliferative.enhancers,i])
}
print("MEL state t.test")
t.test(na.omit(x.mel), na.omit(y.mel), alternative = "greater")$p.value

## MES state
x.mes <- c()
y.mes <- c()
for (i in c("MM029", "MM047", "MM099")){
  x.mes <- c(x.mes, enhancer.vs.MM[rownames(enhancer.vs.MM) %in% proliferative.enhancers,i])
  y.mes <- c(y.mes, enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% proliferative.enhancers,i])
}
print("MES state t.test")
t.test(na.omit(y.mes), na.omit(x.mes), alternative = "greater")$p.value

print("MEL enhancers, MEL vs MES lines")
t.test(na.omit(x.mel), na.omit(x.mes), alternative = "greater")$p.value

print("MES enhancers, MEL vs MES lines")
t.test(na.omit(y.mes), na.omit(y.mel), alternative = "greater")$p.value
```

```{r}
# Wilcoxon test
library(ggpubr)
library(dplyr)
## Values MEL vs MES enhancers per state
wilc.mel <- rbind(data.frame(CPMNorm.FC = na.omit(x.mel), Phenotype = "MEL", State = "MEL"),
                  data.frame(CPMNorm.FC = na.omit(y.mel), Phenotype = "MES", State = "MEL"),
                  data.frame(CPMNorm.FC = na.omit(x.mes), Phenotype = "MEL", State = "MES"),
                  data.frame(CPMNorm.FC = na.omit(y.mes), Phenotype = "MES", State = "MES"))
print("MEL state, MEL vs MES enhancers")
wilcox.test(wilc.mel[wilc.mel$Phenotype == "MEL" & wilc.mel$State == "MEL", "CPMNorm.FC"], wilc.mel[wilc.mel$Phenotype == "MES" & wilc.mel$State == "MEL", "CPMNorm.FC"], alternative = "greater")$p.value
print("MES state, MEL vs MES enhancers")
wilcox.test(wilc.mel[wilc.mel$Phenotype == "MES" & wilc.mel$State == "MES", "CPMNorm.FC"], wilc.mel[wilc.mel$Phenotype == "MEL" & wilc.mel$State == "MES", "CPMNorm.FC"], alternative = "greater")$p.value

## Values MEL lines vs MES lines per enhancer states
print("MEL enhancers, MEL vs MES lines")
wilcox.test(wilc.mel[wilc.mel$Phenotype == "MEL" & wilc.mel$State == "MEL", "CPMNorm.FC"], wilc.mel[wilc.mel$Phenotype == "MEL" & wilc.mel$State == "MES", "CPMNorm.FC"], alternative = "greater")$p.value
print("MES enhancers, MEL vs MES lines")
wilcox.test(wilc.mel[wilc.mel$Phenotype == "MES" & wilc.mel$State == "MES", "CPMNorm.FC"], wilc.mel[wilc.mel$Phenotype == "MES" & wilc.mel$State == "MEL", "CPMNorm.FC"], alternative = "greater")$p.value
```

```{r}
# Bootstrapping followed by t.test
## For MES group
k <- 30 # Bootstrap 21 times
n_mes <- 16 # 16 mes enhancers
n_mel <- 9 # 9 mel enhancers
ratio_vector_mes <- vector()
for (j in c("MM029", "MM047", "MM099")){
  MES <- enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% proliferative.enhancers,j]
  MEL <- enhancer.vs.MM[rownames(enhancer.vs.MM) %in% proliferative.enhancers,j]
  for (i in 1:k){
    subset_mes <- sample(MES, size=n_mes, replace=TRUE) # Sample mes
    subset_mel <- sample(MEL, size=n_mel, replace=TRUE) # Sample mel
    ratio_vector_mes <- c(ratio_vector_mes, median(subset_mes)/median(subset_mel)) # Median ratio
  }
}

## Same for MEL
ratio_vector_mel <- vector()
for (j in c("MM001", "MM057", "MM074", "MM087")){
  MES <- enhancer.vs.MM[!rownames(enhancer.vs.MM) %in% proliferative.enhancers,j]
  MEL <- enhancer.vs.MM[rownames(enhancer.vs.MM) %in% proliferative.enhancers,j]
  for (i in 1:k){
    subset_mes <- sample(MES, size=n_mes, replace=TRUE)
    subset_mel <- sample(MEL, size=n_mel, replace=TRUE)
    ratio_vector_mel <- c(ratio_vector_mel, median(subset_mes)/median(subset_mel))
  }
}
## Test
t.test(ratio_vector_mes, ratio_vector_mel)$p.value
wilcox.test(ratio_vector_mes, ratio_vector_mel)$p.value
```